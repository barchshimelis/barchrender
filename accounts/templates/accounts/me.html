{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{% trans "My Account" %}{% endblock %}

{% block extra_css %}
<style>
    body {
        background:
            linear-gradient(rgba(5, 6, 8, 0.7), rgba(5, 6, 8, 0.7)),
            url("{% static 'img/bg.jpg' %}") center/cover fixed no-repeat;
        background-color: #050608;
    }

    .mobile-shell {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        padding: 0 0 60px 0;
    }
    .glass-card {
        border-radius: 20px;
        padding: 0.85rem 0.95rem;
        background: rgba(19, 25, 33, 0.78);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(12px);
    }
    .hero-card {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        position: relative;
        background: linear-gradient(135deg, rgba(32, 41, 57, 0.95), rgba(12, 16, 21, 0.92));
        z-index: 100;
        overflow: visible;
    }
    .hero-card--with-toolbar {
        padding-top: 3rem;
    }
    .hero-avatar {
        width: 50px;
        height: 50px;
        border-radius: 999px;
        background: linear-gradient(145deg, #f5c274, #e3942d);
        padding: 3px;
        box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }
    .hero-avatar-inner {
        width: 100%;
        height: 100%;
        border-radius: inherit;
        background: rgba(15,17,17,0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-soft, rgba(247,250,250,0.8));
        overflow: hidden;
    }
    .hero-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: inherit;
    }
    .hero-greeting .hello {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
    }
    .hero-greeting .username {
        font-size: 0.75rem;
        margin: 0.1rem 0 0;
        opacity: 0.75;
    }
    .hero-balance {
        margin-left: auto;
        text-align: right;
    }
    .hero-balance .label {
        font-size: 0.55rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: rgba(247,250,250,0.55);
    }
    .hero-balance .invite {
        font-size: 0.5rem;
        font-weight: 600;
        color: #f2b35c;
    }
    .hero-balance .amount {
        margin-top: 0.2rem;
        font-size: 0.7rem;
        font-weight: 700;
        color: #f2b35c;
    }
    .metric-strip {
        display: grid;
        grid-template-columns: repeat(3, minmax(0,1fr));
        gap: 0.45rem;
    }
    .metric-card {
        padding: 0.55rem 0.45rem;
        border-radius: 14px;
        background: rgba(15,17,17,0.65);
        border: 1px solid rgba(255,255,255,0.04);
        text-align: center;
    }
    .metric-icon {
        width: 28px;
        height: 28px;
        border-radius: 9px;
        margin: 0 auto 0.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0f1111;
        font-size: 0.85rem;
        font-weight: 600;
    }
    .metric-icon.teal { background: #007185; color: #f7fafa; }
    .metric-icon.amber { background: #f2b35c; }
    .metric-icon.sky { background: #00a8e1; color: #0f1111; }
    .metric-card p {
        margin: 0;
        font-size: 0.45rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(247,250,250,0.65);
    }
    .metric-card strong {
        font-size: 0.82rem;
        color: #f7fafa;
    }
    .action-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap: 0.55rem;
    }
    .action-tile {
        border-radius: 16px;
        padding: 0.6rem;
        border: none;
        font-weight: 600;
        font-size: 0.78rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        cursor: pointer;
        text-decoration: none;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 6px 14px rgba(0,0,0,0.28);
    }
    .action-tile svg { width: 16px; height: 16px; }
    .action-tile:hover { transform: translateY(-1px); }
    .action-amazon { background: linear-gradient(135deg, #f5c274, #e3942d); color: #0f1111; }
    .action-teal { background: linear-gradient(135deg, #00a8e1, #007185); color: #f7fafa; }
    .action-invite { background: linear-gradient(135deg, #f3c974, #e3942d); color: #0f1111; }
    .action-dark { background: linear-gradient(135deg, #1f2933, #131921); color: #f7fafa; border: 1px solid rgba(255,255,255,0.08); }
    .mission-card {
        background: linear-gradient(135deg, rgba(26,38,52,0.95), rgba(12,16,21,0.92));
        border-radius: 20px;
        padding: 1rem;
        border: 1px solid rgba(255,255,255,0.06);
    }
    .mission-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.6rem;
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(247,250,250,0.7);
    }
    .mission-track { position: relative; }
    .mission-task {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding: 0.25rem 0;
    }
    .mission-media {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        overflow: hidden;
        background: rgba(255,255,255,0.08);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        color: #0f1111;
    }
    .mission-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .mission-info {
        flex: 1;
        min-width: 0;
    }
    .mission-info .title {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 600;
    }
    .mission-info .subtitle {
        margin: 0.1rem 0 0.3rem;
        font-size: 0.72rem;
        color: rgba(247,250,250,0.75);
    }
    .mission-info .meta {
        display: flex;
        gap: 0.75rem;
        font-size: 0.7rem;
        color: #f2b35c;
        flex-wrap: wrap;
    }
    .mission-info .meta span {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
    }
    .mission-cta {
        margin-top: 0.65rem;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.42rem 0.9rem;
        border-radius: 999px;
        background: #f2b35c;
        color: #0f1111;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.78rem;
        box-shadow: 0 10px 25px rgba(242,179,92,0.25);
    }
    .hero-toolbar {
        position: absolute;
        top: 0.85rem;
        left: 0.95rem;
        right: 0.95rem;
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 0.4rem;
    }
    .hero-pill,
    .hero-icon {
        border: none;
        border-radius: 999px;
        padding: 0.35rem 0.85rem;
        background: rgba(247,250,250,0.12);
        color: #f7fafa;
        font-size: 0.35rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        cursor: pointer;
    }
    .hero-icon {
        width: 38px;
        height: 38px;
        justify-content: center;
        padding: 0;
        border-radius: 50%;
    }
    .hero-pill svg,
    .hero-icon svg {
        width: 18px;
        height: 18px;
    }
    .hero-pill { justify-self: center; }
    .hero-icon--left { justify-self: flex-start; }
    .hero-icon--right { justify-self: flex-end; }
    .language-control {
        position: relative;
        justify-self: center;
        display: inline-flex;
        align-items: center;
        z-index: 30;
    }
    .language-toggle {
        border: none;
        border-radius: 999px;
        padding: 0.35rem 0.85rem;
        background: rgba(247,250,250,0.12);
        color: #f7fafa;
        font-size: 0.55rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
    }
    .language-toggle svg {
        width: 18px;
        height: 18px;
    }
    .language-toggle:hover,
    .language-control.is-open .language-toggle {
        background: rgba(247,250,250,0.22);
        transform: translateY(-1px);
    }
    .language-sheet {
        position: absolute;
        top: calc(100% + 0.8rem);
        bottom: auto;
        left: 50%;
        transform: translate(-50%, 0);
        min-width: 170px;
        background: rgba(6,10,16,0.95);
        border: none;
        box-shadow: 0 18px 40px rgba(0,0,0,0.45);
        border-radius: 16px;
        padding: 0.6rem;
        display: none;
        z-index: 60;
    }
    .language-sheet.is-visible {
        display: block;
    }
    .language-sheet__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.35rem;
        font-size: 0.65rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: rgba(247,250,250,0.6);
    }
    .language-sheet__close {
        background: transparent;
        border: none;
        color: rgba(247,250,250,0.6);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
    }
    .language-sheet__close:hover,
    .language-sheet__close:focus-visible {
        background: rgba(247,250,250,0.12);
        color: #f7fafa;
        outline: none;
    }
    .language-list {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        max-height: 240px;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .language-list::-webkit-scrollbar {
        width: 0;
        height: 0;
    }
    .language-option {
        width: 100%;
        border: none;
        border-radius: 12px;
        background: rgba(255,255,255,0.02);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.35rem 0.5rem;
        cursor: pointer;
        color: #f7fafa;
        font-size: 0.7rem;
        transition: background 0.2s ease, transform 0.2s ease;
    }
    .language-option:hover,
    .language-option:focus-visible {
        background: rgba(0,168,225,0.15);
        transform: translateX(3px);
        outline: none;
    }
    .language-option.is-current {
        background: rgba(0,168,225,0.25);
        cursor: default;
    }
    .language-option[disabled] {
        opacity: 1;
    }
    .language-option__text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.05rem;
    }
    .language-option__code {
        font-size: 0.6rem;
        color: rgba(247,250,250,0.65);
        letter-spacing: 0.08em;
    }
    .language-flag {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.12);
        flex-shrink: 0;
    }
    .language-flag img {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
    }
    .section-title {
        margin: 0 0 0.4rem;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: rgba(247,250,250,0.75);
    }
    .quick-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.55rem;
    }
    .quick-link {
        border-radius: 16px;
        padding: 0.6rem;
        background: rgba(15,17,17,0.65);
        border: 1px solid rgba(255,255,255,0.04);
        color: #f7fafa;
        text-decoration: none;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        align-items: center;
        transition: transform 0.2s, border-color 0.2s;
    }
    .quick-link:hover {
        transform: translateY(-2px);
        border-color: rgba(255,255,255,0.15);
    }
    .quick-link svg { width: 24px; height: 24px; }
    .quick-link span {
        font-size: 0.72rem;
        font-weight: 600;
    }
    .signout-card {
        text-align: center;
        padding: 1.1rem;
    }
    .signout-card p {
        margin: 0 0 0.4rem;
        color: rgba(247,250,250,0.7);
    }
    .signout-btn {
        border-radius: 999px;
        background: linear-gradient(120deg, #f2b35c, #ec7f2c);
        border: none;
        color: #0f1111;
        font-weight: 600;
        padding: 0.5rem 1.3rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    .signout-btn svg { width: 20px; height: 20px; }
    .bottom-pad { height: 30px; }
    @media (min-width: 992px) {
        .page-shell {
            padding-left: clamp(1rem, 2.5vw, 2.5rem);
            padding-right: clamp(1rem, 2.5vw, 2.5rem);
        }
        .page-shell > .container {
            max-width: none;
            width: 100%;
        }
        .mobile-shell {
            max-width: 1200px;
            margin: 0 auto;
        }
    }
    @media (max-width: 520px) {
        .hero-toolbar { justify-content: center; }
        .hero-card { flex-direction: column; align-items: flex-start; }
        .hero-balance { text-align: left; margin-left: 0; }
        .quick-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.45rem;
        }
    }
    @media (max-width: 420px) {
        .mobile-shell { padding-bottom: 60px; }
    }
    .chat-launcher-floating {
        position: fixed;
        right: clamp(1rem, 3vw, 1.5rem);
        bottom: clamp(4.5rem, 12vw, 5.5rem);
        z-index: 1200;
        display: inline-flex;
        align-items: center;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        justify-content: center;
        padding: 0;
        background: linear-gradient(130deg, #38bdf8, #0ea5e9);
        color: #0f1111;
        font-weight: 600;
        font-size: 0.8rem;
        text-decoration: none;
        box-shadow: 0 18px 38px rgba(14, 165, 233, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .chat-launcher-floating svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
    }
    .chat-launcher-floating:hover {
        transform: translateY(-2px);
        box-shadow: 0 22px 44px rgba(14, 165, 233, 0.45);
    }
</style>
{% endblock %}

{% block content %}
<div class="mobile-shell" role="main" aria-labelledby="meHeading">
    <section class="glass-card hero-card hero-card--with-toolbar" id="meHeading">
        <div class="hero-toolbar">
            <button class="hero-icon hero-icon--left" type="button" aria-label="{% trans 'Notifications' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                    <path d="M6 8a6 6 0 0112 0v4.8l1.2 2.4H4.8L6 12.8V8z"></path>
                    <path d="M9 18a3 3 0 006 0" stroke-linecap="round"></path>
                </svg>
            </button>
            <div class="language-control" data-language-control>
                <button class="hero-pill" type="button" aria-label="{% trans 'Change language' %}" aria-expanded="false" data-language-toggle>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <circle cx="12" cy="12" r="9"></circle>
                        <path d="M2.05 12H21.95M12 2.05a15.3 15.3 0 010 19.9M12 2.05a15.3 15.3 0 000 19.9"></path>
                    </svg>
                    {% trans "Change language" %}
                </button>
                <form method="post" action="{% url 'set_language' %}" class="language-sheet" data-language-sheet>
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}" data-language-next>
                    <div class="language-sheet__header">
                        <span>{% trans "Choose language" %}</span>
                        <button type="button" class="language-sheet__close" aria-label="{% trans 'Close language menu' %}" data-language-close>&times;</button>
                    </div>
                    <div class="language-list">
                        {% for language in language_info_list %}
                            {% with language.code as lang_code %}
                                <button
                                    type="submit"
                                    name="language"
                                    value="{{ lang_code }}"
                                    class="language-option {% if lang_code == current_language_code %}is-current{% endif %}"
                                    data-language-option
                                    data-language-code="{{ lang_code }}"
                                    {% if lang_code == current_language_code %}disabled aria-current="true"{% endif %}>
                                    <span class="language-flag">
                                        <img data-flag="{{ lang_code }}" data-flag-label="{{ language.name_local|default:language.name }}" alt="">
                                    </span>
                                    <span class="language-option__text">
                                        <strong>{{ language.name_local|default:language.name }}</strong>
                                        <span class="language-option__code">{{ lang_code|upper }}</span>
                                    </span>
                                </button>
                            {% endwith %}
                        {% endfor %}
                    </div>
                </form>
            </div>
            <a class="hero-icon hero-icon--right" href="{% url 'accounts:profile' %}" aria-label="{% trans 'Settings' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                    <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"></path>
                    <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 005 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 005 8a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 008 4.6 1.65 1.65 0 009.51 3H10a2 2 0 014 0h.09a1.65 1.65 0 001.51 1 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9c.63 0 1.21.37 1.51 1H21a2 2 0 010 4h-.09c-.3.63-.88 1-1.51 1z"></path>
            </svg>
            </a>
        </div>
      
    </section>

    <section class="metric-strip">
            
          
                
          
            
        </section>

        <section class="glass-card">
            
            <div class="balance-amount">${{ user_balance|default:0|floatformat:2 }}</div>
        </section>

        <section class="action-grid">
            <a class="action-tile action-amazon" href="{% url 'balance:recharge_amount' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="#0f1111" stroke-width="1.8">
                    <rect x="4" y="6" width="16" height="12" rx="3"></rect>
                    <path d="M9 12l3-3 3 3" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                {% trans "Recharge" %}
            </a>
            <a class="action-tile action-teal" href="{% url 'wallet:withdraw' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="#f7fafa" stroke-width="1.8">
                    <rect x="4" y="6" width="16" height="12" rx="3"></rect>
                    <path d="M15 12l-3 3-3-3" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                {% trans "Withdraw" %}
            </a>
            
            
        </section>

       

        <section class="glass-card">
            <p class="section-title">{% trans "Quick access" %}</p>
            <div class="quick-grid">
                <a class="quick-link" href="{% url 'accounts:profile' %}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path d="M12 12a5 5 0 100-10 5 5 0 000 10z"></path>
                        <path d="M4 22a8 8 0 0116 0" stroke-linecap="round"></path>
                    </svg>
                    <span>{% trans "Personal info" %}</span>
                </a>
                <a class="quick-link" href="{% url 'accounts:activities' %}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round"></path>
                        <path d="M9 6v12" stroke-linecap="round"></path>
                    </svg>
                    <span>{% trans "Order record" %}</span>
                </a>
                <a class="quick-link" href="{% url 'accounts:activities' %}#recharge-history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <rect x="3" y="4" width="18" height="16" rx="3"></rect>
                        <path d="M3 10h18M8 15h2" stroke-linecap="round"></path>
                    </svg>
                    <span>{% trans "Recharge record" %}</span>
                </a>
                <a class="quick-link" href="{% url 'accounts:activities' %}#withdraw-history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path d="M12 5v14" stroke-linecap="round"></path>
                        <path d="M17 9H9a3 3 0 000 6h6a3 3 0 010 6H7" stroke-linecap="round"></path>
                    </svg>
                    <span>{% trans "Withdrawal record" %}</span>
                </a>
               
                
            </div>
        </section>

        <section class="glass-card signout-card">
          
            <a href="{% url 'accounts:logout' %}" class="signout-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                    <path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"></path>
                    <path d="M10 17l5-5-5-5"></path>
                    <path d="M15 12H3"></path>
                </svg>
                {% trans "Sign out" %}
            </a>
        </section>
        <div class="bottom-pad"></div>
    </div>
</div>
<a class="chat-launcher-floating" href="{% url 'chat:user_support_portal' %}" aria-label="{% trans 'Chat with Customer Service' %}">
    <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M21 11.5a8.5 8.5 0 00-17 0 8.37 8.37 0 001.41 4.63L3 21l4.87-1.43A8.5 8.5 0 0021 11.5z"></path>
        <path d="M9 10h6M9 13h3" stroke="#0f1111" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
</a>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const languageControl = document.querySelector("[data-language-control]");
        if (!languageControl) {
            return;
        }

        const languageToggle = languageControl.querySelector("[data-language-toggle]");
        const languageSheet = languageControl.querySelector("[data-language-sheet]");
        const languageClose = languageControl.querySelector("[data-language-close]");
        const languageOptions = languageControl.querySelectorAll("[data-language-option]");
        const languageNextInput = languageControl.querySelector("[data-language-next]");
        const flagImages = languageControl.querySelectorAll("[data-flag]");

        const flagMap = {
            "en": "{% static 'flags/en.png' %}",
            "ar": "{% static 'flags/ar.png' %}",
            "tr": "{% static 'flags/tr.png' %}",
            "ru": "{% static 'flags/ru.png' %}",
            "az": "{% static 'flags/az.png' %}",
            "th": "{% static 'flags/th.png' %}",
            "be": "{% static 'flags/be.png' %}",
            "es": "{% static 'flags/es.png' %}",
            "pt": "{% static 'flags/pt.png' %}",
            "vi": "{% static 'flags/vi.png' %}",
            "sq": "{% static 'flags/sq.png' %}",
            "es-cl": "{% static 'flags/es-cl.png' %}",
            "es-mx": "{% static 'flags/es-mx.png' %}",
            "en-ng": "{% static 'flags/en-ng.png' %}",
            "et": "{% static 'flags/et.png' %}",
        };
        const fallbackFlag = "{% static 'img/language.png' %}";

        const normalizeCode = (code) => {
            if (!code) return "";
            return code.toLowerCase().replace("_", "-");
        };

        const resolveFlag = (code) => flagMap[normalizeCode(code)] || fallbackFlag;

        const supportedLangs = Array.from(languageOptions).map((option) =>
            normalizeCode(option.dataset.languageCode)
        );

        const buildLocalizedNext = (targetCode) => {
            if (!targetCode) return window.location.href;

            const url = new URL(window.location.href);
            const segments = url.pathname.split("/").filter(Boolean);
            const normalizedTarget = normalizeCode(targetCode);

            if (segments.length && supportedLangs.includes(normalizeCode(segments[0]))) {
                segments[0] = normalizedTarget;
            } else {
                segments.unshift(normalizedTarget);
            }

            const localizedPath = `/${segments.join("/") || ""}`;
            return `${localizedPath}${url.search}${url.hash}`;
        };

        flagImages.forEach((img) => {
            const code = img.dataset.flag;
            img.src = resolveFlag(code);
            const label = img.dataset.flagLabel || code?.toUpperCase() || "";
            img.alt = label ? `${label} flag` : "";
        });

        const openSheet = () => {
            languageSheet?.classList.add("is-visible");
            languageControl?.classList.add("is-open");
            languageToggle?.setAttribute("aria-expanded", "true");
        };

        const closeSheet = () => {
            languageSheet?.classList.remove("is-visible");
            languageControl?.classList.remove("is-open");
            languageToggle?.setAttribute("aria-expanded", "false");
        };

        languageToggle?.addEventListener("click", (event) => {
            event.preventDefault();
            if (languageSheet?.classList.contains("is-visible")) {
                closeSheet();
            } else {
                openSheet();
            }
        });

        languageClose?.addEventListener("click", (event) => {
            event.preventDefault();
            closeSheet();
        });

        document.addEventListener("click", (event) => {
            if (languageSheet?.classList.contains("is-visible") && !languageControl.contains(event.target)) {
                closeSheet();
            }
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape" && languageSheet?.classList.contains("is-visible")) {
                closeSheet();
            }
        });

        languageOptions.forEach((option) => {
            option.addEventListener("click", () => {
                if (!languageNextInput) return;
                const targetCode = option.dataset.languageCode;
                languageNextInput.value = buildLocalizedNext(targetCode);
            });
        });
    });
</script>
{% endblock %}


